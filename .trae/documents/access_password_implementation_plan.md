# FanStudio 访问密码功能实施计划

## [x] 任务 1: 修改数据库模型添加访问密码字段
- **优先级**: P0
- **依赖关系**: 无
- **描述**:
  - 在 `prisma/schema.prisma` 中的 `Settings` 模型添加 `accessPassword` 字段
  - 运行数据库迁移应用更改
- **成功标准**:
  - 数据库模型修改成功
  - 迁移文件创建并应用
- **测试要求**:
  - `programmatic` TR-1.1: 运行 `npx prisma migrate dev` 命令成功
  - `programmatic` TR-1.2: 数据库中 `Settings` 表包含 `accessPassword` 字段

## [x] 任务 2: 更新设置相关API和工具函数
- **优先级**: P0
- **依赖关系**: 任务 1
- **描述**:
  - 更新 `src/lib/settings-db.ts` 中的类型定义和默认值
  - 更新 `src/app/api/settings/route.ts` 中的API处理逻辑
- **成功标准**:
  - 设置API能够正确处理 `accessPassword` 字段
  - 类型定义更新完成
- **测试要求**:
  - `programmatic` TR-2.1: `GET /api/settings` 返回包含 `accessPassword` 字段
  - `programmatic` TR-2.2: `PUT /api/settings` 能够更新 `accessPassword` 字段

## [x] 任务 3: 在后台设置页面添加访问密码配置
- **优先级**: P0
- **依赖关系**: 任务 2
- **描述**:
  - 在 `src/app/admin/(dashboard)/settings/page.tsx` 中添加访问密码设置选项
  - 添加密码输入框和相关验证
- **成功标准**:
  - 后台设置页面显示访问密码配置选项
  - 能够保存和更新访问密码
- **测试要求**:
  - `human-judgement` TR-3.1: 后台设置页面显示访问密码输入框
  - `programmatic` TR-3.2: 保存访问密码后，API返回更新后的值

## [x] 任务 4: 创建前端访问密码验证页面
- **优先级**: P0
- **依赖关系**: 任务 2
- **描述**:
  - 在 `src/app/(frontend)/` 目录下创建 `password/` 文件夹
  - 创建密码输入页面 `page.tsx`
  - 实现密码验证逻辑
- **成功标准**:
  - 密码输入页面创建完成
  - 验证逻辑实现完成
- **测试要求**:
  - `human-judgement` TR-4.1: 密码输入页面显示正确
  - `programmatic` TR-4.2: 输入正确密码后能够通过验证
  - `programmatic` TR-4.3: 输入错误密码后显示错误提示

## [x] 任务 5: 实现前端访问控制逻辑
- **优先级**: P0
- **依赖关系**: 任务 4
- **描述**:
  - 在 `src/app/(frontend)/layout.tsx` 中添加访问控制逻辑
  - 实现localStorage存储验证状态
  - 确保验证通过后才能访问前台页面
- **成功标准**:
  - 未验证时重定向到密码输入页面
  - 验证通过后能够访问所有前台页面
  - 刷新页面后保持验证状态
- **测试要求**:
  - `programmatic` TR-5.1: 未验证时访问前台页面重定向到密码页面
  - `programmatic` TR-5.2: 验证通过后能够访问所有前台页面
  - `programmatic` TR-5.3: 刷新页面后验证状态保持

## [x] 任务 6: 创建访问密码验证API端点
- **优先级**: P0
- **依赖关系**: 任务 2
- **描述**:
  - 在 `src/app/api/` 目录下创建 `access/` 文件夹
  - 创建密码验证端点 `verify/route.ts`
  - 实现密码验证逻辑
- **成功标准**:
  - API端点创建完成
  - 能够正确验证密码
- **测试要求**:
  - `programmatic` TR-6.1: `POST /api/access/verify` 能够验证密码
  - `programmatic` TR-6.2: 正确密码返回成功状态
  - `programmatic` TR-6.3: 错误密码返回失败状态

## [x] 任务 7: 确保后台页面不受访问密码限制
- **优先级**: P1
- **依赖关系**: 任务 5
- **描述**:
  - 确保 `src/app/admin/` 下的所有页面不受访问密码限制
  - 验证后台登录和管理页面能够正常访问
- **成功标准**:
  - 后台页面无需输入访问密码
  - 能够正常登录和使用后台功能
- **测试要求**:
  - `human-judgement` TR-7.1: 直接访问 `/admin` 页面无需输入访问密码
  - `human-judgement` TR-7.2: 后台登录和管理功能正常

## [x] 任务 8: 测试完整的访问密码功能
- **优先级**: P0
- **依赖关系**: 所有任务
- **描述**:
  - 测试完整的访问密码流程
  - 验证各种场景下的功能表现
  - 确保用户体验流畅
- **成功标准**:
  - 访问密码功能正常工作
  - 用户体验良好
- **测试要求**:
  - `human-judgement` TR-8.1: 完整流程测试通过
  - `human-judgement` TR-8.2: 用户体验流畅
  - `programmatic` TR-8.3: 无错误日志

## 实现方案说明

### 技术实现细节

1. **数据库模型修改**:
   - 在 `Settings` 模型中添加 `accessPassword` 字段，类型为 `String?`
   - 使用 bcryptjs 对密码进行加密存储

2. **前端验证流程**:
   - 用户访问前台页面时，检查 localStorage 中的验证状态
   - 未验证时重定向到密码输入页面
   - 用户输入密码后，调用验证API
   - 验证通过后，在 localStorage 中存储验证状态
   - 验证状态有效期设为30天

3. **后台设置**:
   - 在网站设置页面添加访问密码设置选项
   - 提供密码输入框和确认框
   - 支持设置和清除访问密码

4. **安全考虑**:
   - 密码使用 bcryptjs 加密存储
   - 验证API使用 POST 请求
   - 前端不存储原始密码，只存储验证状态

### 预期效果

- **启用访问密码后**:
  - 所有前台页面需要输入正确密码才能访问
  - 后台管理页面不受限制
  - 用户输入一次密码后，30天内无需再次输入

- **禁用访问密码后**:
  - 所有用户可以直接访问前台页面
  - 之前的验证状态自动失效

### 风险和注意事项

- **风险**: 访问密码可能被浏览器开发者工具绕过
- **缓解**: 主要用于防止普通用户访问，不是严格的安全措施

- **风险**: localStorage 被清除后需要重新输入密码
- **缓解**: 这是预期行为，确保用户在清除浏览器数据后需要重新验证

- **注意事项**: 确保后台页面不受访问密码限制
- **缓解**: 在布局组件中明确区分前台和后台路由